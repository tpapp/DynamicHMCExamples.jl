<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Multinomial logistic regression · DynamicHMCExamples.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">DynamicHMCExamples.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../example_independent_bernoulli/">Estimate Bernoulli draws probabilility</a></li><li><a class="tocitem" href="../example_linear_regression/">Linear regression</a></li><li><a class="tocitem" href="../example_logistic_regression/">Logistic regression</a></li><li class="is-active"><a class="tocitem" href>Multinomial logistic regression</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Multinomial logistic regression</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Multinomial logistic regression</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/tpapp/DynamicHMCExamples.jl/blob/master/src/example_multinomial_logistic_regression.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Multinomial-logistic-regression"><a class="docs-heading-anchor" href="#Multinomial-logistic-regression">Multinomial logistic regression</a><a id="Multinomial-logistic-regression-1"></a><a class="docs-heading-anchor-permalink" href="#Multinomial-logistic-regression" title="Permalink"></a></h1><pre><code class="language-julia hljs">using TransformVariables, LogDensityProblems, DynamicHMC, DynamicHMC.Diagnostics,
    TransformedLogDensities,  Parameters, Statistics, Random, Distributions,
    MCMCDiagnosticTools, LogExpFunctions, FillArrays, LinearAlgebra
import ForwardDiff # use for automatic differentiation (AD)

&quot;&quot;&quot;
Multinomial logistic regression.

For each draw, ``Pr(yᵢ) ∼ softmax(Xᵢ β)``. Uses a `β ∼ MultivariateNormal(0, σI)` prior.

`X` is supposed to include the `1`s for the intercept.
&quot;&quot;&quot;
struct MultinomialLogisticRegression{Ty, TX, Tσ}
    y::Ty
    X::TX
    σ::Tσ
end

function (problem::MultinomialLogisticRegression)(θ)
    @unpack y, X, σ = problem
    @unpack β = θ
    num_rows, num_covariates = size(X)
    num_classes = size(β, 2) + 1
    η = X * hcat(zeros(num_covariates), β) # the first column of all zeros corresponds to the base class
    μ = softmax(η; dims = 2)
    D = MvNormal(Diagonal(Fill(σ ^ 2, num_classes - 1)))
    ℓ_likelihood = mapreduce((μ, y) -&gt; logpdf(Multinomial(1, μ), y), +, eachrow(μ), eachrow(y))
    ℓ_prior = mapreduce(β -&gt; logpdf(D, β), +, eachrow(β))
    ℓ_likelihood + ℓ_prior
end</code></pre><p>Make up parameters, generate data using random draws.</p><pre><code class="language-julia hljs">N = 10_000</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">10000</code></pre><p>There are two covariates. The first one (the column of all ones) is the intercept.</p><pre><code class="language-julia hljs">X = hcat(ones(N), randn(N));</code></pre><p>If we have C classes, then for each covariate we need (C - 1) coefficients. we consider the first class to be the &quot;base class&quot; and then for each of the other classes, we have a coefficient comparing that class to the base class In this example, we have four classes, so we need three coefficients for each covariate. There are two covariates, so we will have six coefficients in total. the rows of β correspond to the covariates e.g. the first row of β corresponds to the first covariate (the intercept) e.g. the second row of β corresponds to the second covariate the columns of β correspond to classes recall that we set the first class as our &quot;base class&quot; then the jth column of β contains the coefficients comparing the (j+1) class against the first class e.g. the first column of β contains coefficients comparing the second class against the first class e.g. the second column of β contains coefficients comparing the third class against the first class e.g. the third column of β contains coefficients comparing the fourth class against the first class</p><pre><code class="language-julia hljs">β_true = [1.0 2.0 3.0;
          4.0 5.0 6.0]
η = X * hcat(zeros(size(β_true, 1)), β_true);
μ = softmax(η; dims = 2);</code></pre><p>y has N rows and C columns the rows of y correspond to observations the columns of y correspond to classes</p><pre><code class="language-julia hljs">y = mapreduce(μ -&gt; permutedims(rand(Multinomial(1, μ))), vcat, eachrow(μ))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">10000×4 Matrix{Int64}:
 1  0  0  0
 0  0  0  1
 0  0  0  1
 0  1  0  0
 1  0  0  0
 0  0  1  0
 0  0  0  1
 0  0  0  1
 0  0  0  1
 0  0  1  0
 ⋮        
 0  0  0  1
 1  0  0  0
 1  0  0  0
 0  0  1  0
 0  0  0  1
 0  0  0  1
 0  0  0  1
 0  0  0  1
 0  0  0  1</code></pre><p>Create a problem, apply a transformation, then use automatic differentiation.</p><pre><code class="language-julia hljs">p = MultinomialLogisticRegression(y, X, 100.0) # data and (vague) priors
t = as((β = as(Array, size(β_true)), )) # identity transformation, just to get the dimension
P = TransformedLogDensity(t, p)         # transformed
∇P = ADgradient(:ForwardDiff, P)        # use ForwardDiff for automatic differentiation</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ForwardDiff AD wrapper for TransformedLogDensity of dimension 6, w/ chunk size 6</code></pre><p>Sample using NUTS, random starting point.</p><pre><code class="language-julia hljs">results = map(_ -&gt; mcmc_with_warmup(Random.default_rng(), ∇P, 1000), 1:3)

posterior = transform.(t, eachcol(pool_posterior_matrices(results)));</code></pre><p>Extract the posterior. (Here the transformation was not really necessary).</p><pre><code class="language-julia hljs">β_posterior = first.(posterior)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3000-element Vector{Matrix{Float64}}:
 [0.9283439567453082 1.9511209380497887 3.0432764261387044; 3.8042846746450967 4.85111770391452 5.783238302304368]
 [0.8780066616322013 1.9646688866601028 2.9421756887832156; 3.6848904157394013 4.869667760377807 5.837982980529531]
 [0.9111817529357379 1.9839530127754448 2.989482892256679; 3.9546401621291514 5.0227221320438735 5.95896678676093]
 [0.9170359187132413 1.90512228075594 2.958459187318153; 4.039028249174733 5.014433193484251 5.901015451041016]
 [0.9186071975243675 2.012527218480554 3.063703071000777; 3.68877588360248 4.9525300362937195 5.820113044957364]
 [0.7633029385897702 1.7841414512282598 2.885026033241212; 3.8521434619835015 5.038421999271319 5.828024030422591]
 [0.8095737474355024 1.8833683671896337 2.8990684011235826; 3.819582350874109 4.762221095474253 5.834550403337991]
 [0.8287646726034598 1.8699940645182358 2.907915156470978; 3.7908467505351635 4.855844534190551 5.850098099452033]
 [0.9172918257460063 1.8690797168972113 2.9059794829383856; 3.680049655447296 4.8643227244434035 5.778586690577987]
 [0.9275206589755557 1.8920422080996147 2.9014782215424186; 3.715991842484797 4.848740629221188 5.792732233295287]
 ⋮
 [1.0477785582447243 2.0967001995252863 3.1565176168852482; 4.030570056797793 5.172076837418673 6.169021308719435]
 [0.9998832030584205 2.034793360872728 3.0819469500885437; 4.119203769832447 5.072022759637967 6.022436727758601]
 [1.0166850330394848 2.0798788849287044 3.0974684363537848; 3.960049690320698 5.093622213306466 6.0682444877749875]
 [0.9074172838688059 1.8887432678319758 2.9518314171251343; 3.7599815130611653 4.8624882060971 5.763426812511143]
 [0.9657254658855212 1.9854783300388132 3.0362131469114733; 3.907565496924229 4.961574230144356 5.879903903214408]
 [1.0070722914249854 2.1015899873608985 3.120558766858284; 4.006136996494685 5.200527492435826 6.146348511490026]
 [0.9609201635556289 1.9972102140898775 3.02552922057082; 3.942706892519237 5.047097166689703 6.037038358835351]
 [0.8588625332836453 1.9725971806114773 2.995280635256477; 4.043185386575863 5.095354854749067 6.043809394777765]
 [1.0016636645290196 2.0022038874130192 3.0524692343484237; 3.9409314419079857 5.116471836990413 6.025881508730401]</code></pre><p>Check that we recover the parameters.</p><pre><code class="language-julia hljs">mean(β_posterior)

function _median(x)
    n = length(x)
    result = similar(first(x))
    for i in eachindex(result)
	result[i] = median([x[j][i] for j = 1:n])
    end
	return result
end

_median(β_posterior)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×3 Matrix{Float64}:
 0.912709  1.97046  3.01155
 3.85278   4.97941  5.92292</code></pre><p>Quantiles</p><pre><code class="language-julia hljs">qs = [0.05, 0.25, 0.5, 0.75, 0.95]
quantile([β_posterior[i][1, 1] for i in 1:length(β_posterior)], qs)
quantile([β_posterior[i][1, 2] for i in 1:length(β_posterior)], qs)
quantile([β_posterior[i][1, 3] for i in 1:length(β_posterior)], qs)
quantile([β_posterior[i][2, 1] for i in 1:length(β_posterior)], qs)
quantile([β_posterior[i][2, 2] for i in 1:length(β_posterior)], qs)
quantile([β_posterior[i][2, 3] for i in 1:length(β_posterior)], qs)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">5-element Vector{Float64}:
 5.699928370659833
 5.830483765630946
 5.922923942279973
 6.011836281678305
 6.1399199457859455</code></pre><p>Check that mixing is good.</p><pre><code class="language-julia hljs">ess, R̂ = ess_rhat(stack_posterior_matrices(results))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">([646.2780793525726, 561.6081090789797, 596.904505769779, 490.7633663179305, 586.4740937193793, 496.2131031496575], [1.0026751357950516, 1.0031554607175548, 1.0039494961826712, 1.0037515323031225, 1.0032266763967144, 1.0038556454940195])</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../example_logistic_regression/">« Logistic regression</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Friday 2 September 2022 13:46">Friday 2 September 2022</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
